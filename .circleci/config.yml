version: 2.1
jobs:
  build-and-deploy:
    docker:
      - image: cimg/python: 3.11-slim
    steps:
      - checkout
      # Enable Docker support
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Install Google Cloud SDK
          command: |
            curl https://sdk.cloud.google.com | bash > /dev/null 2>&1
            source $HOME/google-cloud-sdk/path.bash.inc
      # Install dependencies and run tests
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "requirements.txt" }}
      - run:
          name: Install Dependencies
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --no-cache-dir -r requirements.txt
      - save_cache:
          paths:
            - ./venv
          key: v1-dependencies-{{ checksum "requirements.txt" }}
      - run:
          name: Run Tests
          command: |
            . venv/bin/activate
            pytest tests/ -v
      # Authenticate with Google Cloud
      - run:
          name: Authenticate Google Cloud
          command: |
            export PATH=$HOME/google-cloud-sdk/bin:$PATH
            echo $GOOGLE_CLOUD_KEYFILE_JSON | base64 -d > ${HOME}/gcloud-service-key.json
            gcloud auth activate-service-account --key-file=${HOME}/gcloud-service-key.json
            gcloud config set project $GOOGLE_CLOUD_PROJECT
      # Configure Docker to use Google Cloud auth
      - run:
          name: Configure Docker Authentication
          command: |
            export PATH=$HOME/google-cloud-sdk/bin:$PATH
            gcloud auth configure-docker us-central1-docker.pkg.dev
      # Create Artifact Registry repository if it doesn't exist
      - run:
          name: Create Artifact Registry Repository if needed
          command: |
            export PATH=$HOME/google-cloud-sdk/bin:$PATH
            if ! gcloud artifacts repositories describe images --location=us-central1 --project=$GOOGLE_CLOUD_PROJECT > /dev/null 2>&1; then
              gcloud artifacts repositories create images \
                --repository-format=docker \
                --location=us-central1 \
                --project=$GOOGLE_CLOUD_PROJECT
            fi
      # Build and push the image directly to Artifact Registry
      - run:
          name: Build and Push Docker Image
          command: |
            export PATH=$HOME/google-cloud-sdk/bin:$PATH
            docker build -t us-central1-docker.pkg.dev/$GOOGLE_CLOUD_PROJECT/images/text-summarizer:latest .
            docker push us-central1-docker.pkg.dev/$GOOGLE_CLOUD_PROJECT/images/text-summarizer:latest
      # Deploy to Cloud Run
      - run:
          name: Deploy to Google Cloud Run
          command: |
            export PATH=$HOME/google-cloud-sdk/bin:$PATH
            gcloud run deploy text-summarizer \
              --image=us-central1-docker.pkg.dev/$GOOGLE_CLOUD_PROJECT/images/text-summarizer:latest \
              --platform=managed \
              --region=us-central1 \
              --allow-unauthenticated \
              --update-env-vars GOOGLE_API_KEY=$GOOGLE_API_KEY

workflows:
  build-deploy:
    jobs:
      - build-and-deploy:
          context:
            - gcp_deploy